name: Update Dependencies

on:
  schedule:
    # æ¯å‘¨ä¸€çš„ UTC æ—¶é—´ 02:00 è¿è¡Œ
    - cron: "0 2 * * 1"
  workflow_dispatch:

jobs:
  update-deps:
    name: Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      - name: Update Fresh framework
        run: deno task update

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run tests after update
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          deno task check
          deno test --allow-all

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies"
          title: "ğŸ”„ è‡ªåŠ¨æ›´æ–°ä¾èµ–é¡¹"
          body: |
            ## ğŸ”„ è‡ªåŠ¨ä¾èµ–æ›´æ–°

            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»ºï¼Œç”¨äºæ›´æ–°é¡¹ç›®ä¾èµ–é¡¹ã€‚

            ### æ›´æ”¹å†…å®¹
            - æ›´æ–°äº† Fresh æ¡†æ¶å’Œç›¸å…³ä¾èµ–
            - è‡ªåŠ¨è¿è¡Œäº†ä»£ç æ£€æŸ¥å’Œæµ‹è¯•

            ### éªŒè¯æ­¥éª¤
            - [x] ä»£ç æ ¼å¼åŒ–æ£€æŸ¥é€šè¿‡
            - [x] Lint æ£€æŸ¥é€šè¿‡
            - [x] ç±»å‹æ£€æŸ¥é€šè¿‡
            - [x] æµ‹è¯•é€šè¿‡

            è¯·å®¡æŸ¥æ›´æ”¹å¹¶åœ¨ç¡®è®¤æ— é—®é¢˜ååˆå¹¶ã€‚

            ---

            ğŸ¤– æ­¤ PR ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»º
          branch: "auto-update-deps"
          delete-branch: true
          labels: |
            dependencies
            automated
