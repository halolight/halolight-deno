name: æ¸…ç†å¤±è´¥å·¥ä½œæµ

# æ¯å‘¨ä¸€ UTC æ—¶é—´ 02:00 (åŒ—äº¬æ—¶é—´å‘¨ä¸€ä¸Šåˆ 10:00) è¿è¡Œ
on:
  schedule:
    - cron: "0 2 * * 1"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  cleanup:
    name: æ¸…ç†å¤±è´¥çš„å·¥ä½œæµè¿è¡Œ
    runs-on: ubuntu-latest

    permissions:
      actions: write # éœ€è¦åˆ é™¤å·¥ä½œæµè¿è¡Œçš„æƒé™
      contents: read

    steps:
      - name: æ£€æŸ¥ä»“åº“
        uses: actions/checkout@v4

      - name: æ¸…ç†å¤±è´¥çš„å·¥ä½œæµè¿è¡Œ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`å¼€å§‹æ¸…ç† ${owner}/${repo} çš„å¤±è´¥å·¥ä½œæµè¿è¡Œ...`);

            // è·å–æ‰€æœ‰å·¥ä½œæµ
            const workflows = await github.rest.actions.listRepoWorkflows({
              owner,
              repo
            });

            let totalDeleted = 0;

            for (const workflow of workflows.data.workflows) {
              console.log(`æ£€æŸ¥å·¥ä½œæµ: ${workflow.name} (ID: ${workflow.id})`);

              // è·å–å¤±è´¥çš„å·¥ä½œæµè¿è¡Œ (ä¿ç•™æœ€è¿‘30å¤©å†…çš„)
              const thirtyDaysAgo = new Date();
              thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                status: 'failure',
                per_page: 100,
                created: `<${thirtyDaysAgo.toISOString()}`
              });

              console.log(`æ‰¾åˆ° ${runs.data.workflow_runs.length} ä¸ª30å¤©å‰çš„å¤±è´¥è¿è¡Œ`);

              for (const run of runs.data.workflow_runs) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });
                  console.log(`åˆ é™¤å¤±è´¥è¿è¡Œ: ${run.id} (${run.created_at})`);
                  totalDeleted++;

                  // æ·»åŠ å»¶æ—¶é¿å…APIé™åˆ¶
                  await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                  console.error(`åˆ é™¤è¿è¡Œ ${run.id} å¤±è´¥:`, error.message);
                }
              }

              // åŒæ—¶æ¸…ç†å–æ¶ˆçš„å·¥ä½œæµè¿è¡Œ
              const cancelledRuns = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: workflow.id,
                status: 'cancelled',
                per_page: 100,
                created: `<${thirtyDaysAgo.toISOString()}`
              });

              console.log(`æ‰¾åˆ° ${cancelledRuns.data.workflow_runs.length} ä¸ª30å¤©å‰çš„å–æ¶ˆè¿è¡Œ`);

              for (const run of cancelledRuns.data.workflow_runs) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner,
                    repo,
                    run_id: run.id
                  });
                  console.log(`åˆ é™¤å–æ¶ˆè¿è¡Œ: ${run.id} (${run.created_at})`);
                  totalDeleted++;

                  await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                  console.error(`åˆ é™¤è¿è¡Œ ${run.id} å¤±è´¥:`, error.message);
                }
              }
            }

            console.log(`æ¸…ç†å®Œæˆ! æ€»å…±åˆ é™¤äº† ${totalDeleted} ä¸ªå·¥ä½œæµè¿è¡Œ`);

            // è®¾ç½®è¾“å‡ºä¾›åç»­æ­¥éª¤ä½¿ç”¨
            core.setOutput('deleted_count', totalDeleted);

      - name: æ¸…ç†å·¥ä½œæµè¿è¡Œè®°å½•æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸ§¹ å·¥ä½œæµæ¸…ç†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æ¸…ç†æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- æ¸…ç†è§„åˆ™: åˆ é™¤30å¤©å‰çš„å¤±è´¥å’Œå–æ¶ˆçš„å·¥ä½œæµè¿è¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "- åˆ é™¤æ•°é‡: ${{ steps.cleanup.outputs.deleted_count || '0' }} ä¸ªè¿è¡Œè®°å½•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… æ¸…ç†ä»»åŠ¡å·²å®Œæˆ"  >> $GITHUB_STEP_SUMMARY

      - name: å‘é€é€šçŸ¥ (å¯é€‰)
        if: steps.cleanup.outputs.deleted_count > 0
        run: |
          echo "æœ¬æ¬¡æ¸…ç†åˆ é™¤äº† ${{ steps.cleanup.outputs.deleted_count }} ä¸ªå¤±è´¥çš„å·¥ä½œæµè¿è¡Œ"
